// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

enum UserRole {
  TEACHER
  STUDENT
  ADMIN
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String   // bcrypt hash
  role         UserRole
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  pdfs              PDF[]
  teachingClasses   Class[]              @relation("TeacherClasses")
  classMemberships  ClassMembership[]
  chatConversations ChatConversation[]

  @@index([email])
  @@index([role])
}

// ============================================================================
// CLASS MANAGEMENT
// ============================================================================

model Class {
  id          String   @id @default(cuid())
  teacherId   String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teacher           User                @relation("TeacherClasses", fields: [teacherId], references: [id], onDelete: Cascade)
  memberships       ClassMembership[]
  inviteCodes       InviteCode[]
  sharedMaterials   ClassMaterial[]
  chatConversations ChatConversation[]
  lessons           LessonClass[]       // Lessons shared with this class

  @@index([teacherId])
  @@index([isActive])
}

model ClassMembership {
  id        String   @id @default(cuid())
  classId   String
  userId    String
  role      String   @default("student") // For future: student, TA, etc.
  joinedAt  DateTime @default(now())

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([classId, userId])
  @@index([classId])
  @@index([userId])
}

model InviteCode {
  id         String    @id @default(cuid())
  classId    String
  code       String    @unique // 6-character alphanumeric code
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  createdBy  String    // Teacher user ID
  usedCount  Int       @default(0) // Track how many students used this code

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([classId, isActive])
}

// ============================================================================
// LESSON MANAGEMENT (Reusable lessons)
// ============================================================================

model Lesson {
  id          String   @id @default(cuid())
  creatorId   String   // Teacher who created it
  name        String
  description String?
  isPublic    Boolean  @default(false) // Future: allow sharing with other teachers
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  classes           LessonClass[]        // Classes this lesson is shared with
  pdfs              PDF[]                // PDFs uploaded for this lesson
  materials         Material[]           // Generated materials for this lesson
  chatConversations ChatConversation[]   // Student chats about this lesson
  packet            Packet?              // Digital packet for this lesson

  @@index([creatorId])
  @@index([createdAt])
}

model LessonClass {
  id        String   @id @default(cuid())
  lessonId  String
  classId   String
  sharedAt  DateTime @default(now())
  sharedBy  String   // Teacher user ID
  order     Int      @default(0) // For ordering lessons within a class

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  class  Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([lessonId, classId])
  @@index([classId, order]) // Get all lessons in order for a class
  @@index([lessonId])
}

// ============================================================================
// PDF & CONTENT PROCESSING
// ============================================================================

model PDF {
  id         String   @id @default(cuid())
  userId     String
  lessonId   String?  // Optional: Lesson this PDF belongs to
  filename   String
  blobUrl    String   // Vercel Blob storage URL
  fileSize   Int
  mimeType   String   @default("application/pdf")
  uploadedAt DateTime @default(now())

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson            Lesson?            @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  processedContent  ProcessedContent?
  materials         Material[]
  chatConversations ChatConversation[]

  @@index([userId])
  @@index([lessonId])
}

model ProcessedContent {
  id            String   @id @default(cuid())
  pdfId         String   @unique
  extractedText String   @db.Text // Use Text for large content
  textLength    Int
  processedAt   DateTime @default(now())

  // Relations
  pdf PDF @relation(fields: [pdfId], references: [id], onDelete: Cascade)
}

// ============================================================================
// GENERATED MATERIALS (Worksheets, Flashcards, etc.)
// ============================================================================

enum MaterialType {
  WORKSHEET
  FLASHCARD
  QUIZ
  SUMMARY
}

model Material {
  id        String       @id @default(cuid())
  pdfId     String
  lessonId  String?      // Optional: Lesson this material belongs to
  userId    String       // Teacher who generated it
  type      MaterialType
  title     String
  content   String       @db.Text // JSON content for the material
  createdAt DateTime     @default(now())

  // Relations
  pdf           PDF             @relation(fields: [pdfId], references: [id], onDelete: Cascade)
  lesson        Lesson?         @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  sharedWith    ClassMaterial[]
  conversations ChatConversation[]

  @@index([pdfId])
  @@index([lessonId])
  @@index([userId])
  @@index([type])
}

model ClassMaterial {
  id         String   @id @default(cuid())
  classId    String
  materialId String
  sharedAt   DateTime @default(now())
  sharedBy   String   // Teacher user ID

  // Relations
  class    Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([classId, materialId])
  @@index([classId])
  @@index([materialId])
}

// ============================================================================
// CHAT CONVERSATIONS (with Class & Material Context)
// ============================================================================

model ChatConversation {
  id          String   @id @default(cuid())
  userId      String   // User who started the chat
  classId     String?  // Optional: Which class they're in (null for teacher library)
  lessonId    String?  // Optional: Which lesson they're viewing (for students)
  pdfId       String?  // Optional: PDF they were viewing
  materialId  String?  // Optional: Material they were viewing
  title       String   // Auto-generated or user-provided
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  class    Class?        @relation(fields: [classId], references: [id], onDelete: Cascade)
  lesson   Lesson?       @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  pdf      PDF?          @relation(fields: [pdfId], references: [id], onDelete: SetNull)
  material Material?     @relation(fields: [materialId], references: [id], onDelete: SetNull)
  messages ChatMessage[]

  @@index([userId])
  @@index([classId, createdAt]) // For teacher insights
  @@index([classId, userId]) // Get all chats by student in class
  @@index([lessonId, classId]) // Get all chats about a lesson in a class
  @@index([materialId, classId]) // Get all chats about a material
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // "user" or "assistant"
  content        String   @db.Text
  createdAt      DateTime @default(now())

  // Relations
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

// ============================================================================
// DIGITAL PACKET SYSTEM
// ============================================================================

enum PacketStatus {
  DRAFT
  PUBLISHED
}

enum PacketItemType {
  PDF
  FLASHCARD
  WORKSHEET
}

model Packet {
  id          String       @id @default(cuid())
  lessonId    String       @unique // One packet per lesson
  status      PacketStatus @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  lesson   Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  items    PacketItem[]
  versions PacketVersion[]
  openTabs PacketOpenTab[]

  @@index([lessonId])
  @@index([status])
}

model PacketItem {
  id            String         @id @default(cuid())
  packetId      String
  itemType      PacketItemType
  itemId        String // ID of PDF, Flashcard (Material), or Worksheet (Material)
  order         Int
  editedContent String?        @db.Text // JSON for edited worksheets/flashcards
  createdAt     DateTime       @default(now())

  // Relations
  packet Packet @relation(fields: [packetId], references: [id], onDelete: Cascade)

  @@index([packetId, order])
  @@index([itemType, itemId]) // For querying specific items
}

model PacketVersion {
  id          String   @id @default(cuid())
  packetId    String
  version     Int
  snapshot    String   @db.Text // JSON: Complete packet state at time of publish
  publishedAt DateTime @default(now())
  publishedBy String // userId of teacher who published

  // Relations
  packet Packet @relation(fields: [packetId], references: [id], onDelete: Cascade)

  @@unique([packetId, version])
  @@index([packetId, version])
}

model PacketOpenTab {
  id             String         @id @default(cuid())
  packetId       String
  itemType       PacketItemType
  itemId         String
  order          Int
  lastAccessedAt DateTime       @default(now())

  // Relations
  packet Packet @relation(fields: [packetId], references: [id], onDelete: Cascade)

  @@index([packetId, order])
}
